<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AAST GPA Calculator</title>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --secondary: #7c3aed;
    --dark-bg: #0f172a;
    --card-bg: #1e293b;
    --card-border: #334155;
    --text: #f1f5f9;
    --text-secondary: #94a3b8;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --input-bg: #0b1220; /* Same as before */
    --table-header: #0f1622; /* Same as before */
    --table-border: #263043; /* Same as before */
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--dark-bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }
  
  /* Main Header - New Design */
  .main-header {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--table-border);
    position: sticky;
    top: 0;
    z-index: 1000;
    padding: 12px 16px;
  }
  
  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
  }
  
  .logo-text h1 {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
    color: var(--text);
  }
  
  /* Buttons - New Design */
  .btn {
    padding: 8px 12px;
    border: 1px solid var(--table-border);
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #111827;
    color: var(--text);
  }
  
  .btn-primary {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
  }
  
  .btn-secondary:hover {
    background: rgba(30, 41, 59, 1);
  }
  
  .btn-danger {
    background: var(--danger);
    border-color: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background: #b91c1c;
    transform: translateY(-1px);
  }
  
  /* Main Content */
  .main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
  }
  
  /* Terms Container - Same as before */
  .terms-container {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 16px;
  }
  
  /* Term Card - Same structure, new design */
  .term-card {
    min-width: 1250px; /* EXACT SAME as before */
    border: 1px solid #223048; /* Same as before */
    border-radius: 16px; /* Same as before */
    padding: 12px; /* Same as before */
    overflow: hidden;
  }
  
  /* Different background colors for each term */
  .term-card:nth-child(1) { /* Semester 1 */
    background: linear-gradient(145deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
  }
  
  .term-card:nth-child(2) { /* Semester 2 */
    background: linear-gradient(145deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.05));
  }
  
  .term-card:nth-child(3) { /* Summer 1 */
    background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
  }
  
  .term-card:nth-child(4) { /* Semester 3 */
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
  }
  
  .term-card:nth-child(5) { /* Semester 4 */
    background: linear-gradient(145deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
  }
  
  .term-card:nth-child(6) { /* Summer 2 */
    background: linear-gradient(145deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
  }
  
  .term-card:nth-child(7) { /* Semester 5 */
    background: linear-gradient(145deg, rgba(6, 182, 212, 0.1), rgba(6, 182, 212, 0.05));
  }
  
  .term-card:nth-child(8) { /* Semester 6 */
    background: linear-gradient(145deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05));
  }
  
  .term-card:nth-child(9) { /* Summer 3 */
    background: linear-gradient(145deg, rgba(190, 18, 60, 0.1), rgba(190, 18, 60, 0.05));
  }
  
  .term-card:nth-child(10) { /* Semester 7 */
    background: linear-gradient(145deg, rgba(101, 163, 13, 0.1), rgba(101, 163, 13, 0.05));
  }
  
  .term-card:nth-child(11) { /* Semester 8 */
    background: linear-gradient(145deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05));
  }
  
  .term-card:nth-child(12) { /* Summer 4 */
    background: linear-gradient(145deg, rgba(5, 150, 105, 0.1), rgba(5, 150, 105, 0.05));
  }
  
  .term-card:nth-child(13) { /* Semester 9 */
    background: linear-gradient(145deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.05));
  }
  
  .term-card:nth-child(14) { /* Semester 10 */
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
  }
  
  .term-card:nth-child(15) { /* Summer 5 */
    background: linear-gradient(145deg, rgba(192, 38, 211, 0.1), rgba(192, 38, 211, 0.05));
  }
  
  .term-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
  }
  
  .term-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
    background: rgba(15, 23, 42, 0.7);
    padding: 8px 16px;
    border-radius: 8px;
    backdrop-filter: blur(4px);
  }
  
  .term-stats {
    display: flex;
    gap: 12px; /* Same as before */
  }
  
  .stat-box {
    background: rgba(15, 23, 42, 0.7); /* Same as before */
    border: 1px solid rgba(51, 65, 85, 0.3); /* Lighter border */
    border-radius: 12px; /* Same as before */
    padding: 8px 10px; /* Same as before */
    min-width: 140px; /* Same as before */
    backdrop-filter: blur(4px);
  }
  
  .stat-label {
    font-size: 12px; /* Same as before */
    color: var(--text-secondary);
    margin-bottom: 4px;
  }
  
  .stat-value {
    font-size: 18px; /* Same as before */
    font-weight: 700;
    color: var(--text);
  }
  
  /* Table Styles - EXACT SAME as before */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px; /* Same as before */
    background: rgba(15, 23, 42, 0.3); /* Semi-transparent background */
    border-radius: 8px;
    overflow: hidden;
  }
  
  th, td {
    border: 1px solid rgba(51, 65, 85, 0.3); /* Lighter border */
    padding: 6px; /* Same as before */
    text-align: center; /* Same as before */
  }
  
  th {
    background: rgba(15, 23, 42, 0.8); /* Darker header */
    position: sticky;
    top: 0;
    z-index: 2;
    backdrop-filter: blur(4px);
  }
  
  /* Remove scroll arrows from number inputs - Same as before */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  input[type="number"] {
    -moz-appearance: textfield;
  }
  
  /* Input Styles - EXACT SAME as before */
  input[type="number"], input[type="text"], select {
    width: 100%; 
    background: rgba(15, 23, 42, 0.5); /* Semi-transparent */
    border: 1px solid rgba(51, 65, 85, 0.3); /* Lighter border */
    color: var(--text); 
    padding: 6px 8px; /* Same as before */
    border-radius: 8px; /* Same as before */
    font-size: 13px; /* Same as before */
    backdrop-filter: blur(4px);
  }
  
  input[type="number"]:focus, input[type="text"]:focus, select:focus {
    border-color: rgba(37, 99, 235, 0.5);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    outline: none;
  }
  
  /* Make select dropdowns wider for better visibility - Same as before */
  select {
    min-width: 80px; /* Same as before */
    max-width: 100px; /* Same as before */
  }
  
  input[readonly] {
    opacity: .9; /* Same as before */
    background: rgba(15, 23, 42, 0.3);
  }
  
  /* Range cells - EXACT SAME as before */
  .ranges {
    white-space: normal;
    word-wrap: break-word;
    min-width: 100px; /* Same as before */
    max-width: 120px; /* Same as before */
    padding: 6px; /* Same as before */
    font-size: 12.5px; /* Same as before */
    line-height: 1.3; /* Same as before */
    height: auto;
    text-align: center; /* Same as before */
  }
  
  /* Column width adjustments - EXACT SAME as before */
  td:nth-child(1), th:nth-child(1) { /* Course Code column */
    width: 7%; /* Same as before */
  }
  td:nth-child(2), th:nth-child(2) { /* Subject column */
    width: 18%; /* Same as before */
  }
  td:nth-child(11), th:nth-child(11) { /* Credits column */
    width: 4.5%; /* Same as before */
    min-width: 55px; /* Same as before */
  }
  td:nth-child(12), th:nth-child(12) { /* Grade Letter column */
    width: 6.5%; /* Same as before */
    min-width: 75px; /* Same as before */
  }
  td:nth-child(9), th:nth-child(9) { /* Final Range column */
    width: 8%; /* Same as before */
    min-width: 95px; /* Same as before */
  }
  td:nth-child(10), th:nth-child(10) { /* Total Range column */
    width: 10%; /* Same as before */
    min-width: 120px; /* Same as before */
  }
  td:nth-child(13), th:nth-child(13) { /* Grade Points column */
    width: 6%; /* Same as before */
    min-width: 70px; /* Same as before */
  }
  td:nth-child(14), th:nth-child(14) { /* Quality Points column */
    width: 6.5%; /* Same as before */
    min-width: 85px; /* Same as before */
  }
  
  /* Adjust other columns proportionally - EXACT SAME as before */
  td:nth-child(3), th:nth-child(3),  /* 7th */
  td:nth-child(4), th:nth-child(4),  /* 12th */
  td:nth-child(5), th:nth-child(5),  /* Work */
  td:nth-child(6), th:nth-child(6),  /* Coursework */
  td:nth-child(7), th:nth-child(7),  /* Final */
  td:nth-child(8), th:nth-child(8) { /* Total */
    width: 5%; /* Same as before */
    min-width: 58px; /* Same as before */
  }
  
  /* Overall Stats - New Design */
  .overall-stats {
    margin-top: 20px;
    padding: 16px;
    background: linear-gradient(145deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.05));
    border: 1px solid rgba(51, 65, 85, 0.3);
    border-radius: 16px;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    backdrop-filter: blur(4px);
  }
  
  .overall-stat-box {
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(51, 65, 85, 0.3);
    border-radius: 12px;
    padding: 8px 10px;
    min-width: 160px;
    flex: 1;
    backdrop-filter: blur(4px);
  }
  
  .overall-stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
  }
  
  .overall-stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  
  /* Footer */
  .main-footer {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
    font-size: 14px;
    border-top: 1px solid rgba(51, 65, 85, 0.3);
    margin-top: 20px;
  }
  
  /* Notification */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s;
    backdrop-filter: blur(4px);
  }
  
  .notification.show {
    opacity: 1;
  }
  
  /* Hover effect for table rows */
  tbody tr:hover td {
    background: rgba(255, 255, 255, 0.05) !important;
  }
  
  /* Button group spacing */
  .button-group {
    display: flex;
    gap: 8px;
    margin-left: auto;
  }
</style>
</head>
<body>
  <!-- Main Header -->
  <header class="main-header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">A</div>
        <div class="logo-text">
          <h1>AAST GPA Calculator</h1>
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-primary" id="saveBtn">
          Save to Browser
        </button>
        
        <button class="btn btn-secondary" id="exportBtn">
          Export Data
        </button>
        
        <button class="btn btn-secondary" id="importBtn">
          Import Data
        </button>
        
        <button class="btn btn-danger" id="resetBtn">
          Reset All
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Terms Container -->
    <div class="terms-container" id="terms"></div>

    <!-- Overall Statistics -->
    <div class="overall-stats">
      <div class="overall-stat-box">
        <div class="overall-stat-label">Overall credits</div>
        <div class="overall-stat-value" id="overallCredits">0</div>
      </div>
      
      <div class="overall-stat-box">
        <div class="overall-stat-label">Overall quality points</div>
        <div class="overall-stat-value" id="overallQp">0.00</div>
      </div>
      
      <div class="overall-stat-box">
        <div class="overall-stat-label">Overall cumulative GPA</div>
        <div class="overall-stat-value" id="overallGpa">0.000</div>
      </div>
      
      <div class="overall-stat-box">
        <div class="overall-stat-label">Rounded Overall GPA</div>
        <div class="overall-stat-value" id="overallGpaRounded">0.00</div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="main-footer">
    Â© 2025 Youssof Hossam. All rights reserved.
  </footer>

  <!-- Notification -->
  <div class="notification" id="saveNotification">
    Saved to browser!
  </div>

  <!-- Hidden Import Input -->
  <input type="file" id="importFile" style="display:none" accept=".json">

<script>
(function(){
  const SUBJECT_ROWS = 8;
  const GRADE_POINTS = {"A+":4.0,"A":3.8,"A-":3.7,"B+":3.3,"B":3.0,"B-":2.7,"C+":2.3,"C":2.0,"C-":1.7,"D+":1.3,"D":1.0,"F":0.0};
  const GRADE_RANGES = [
    {label:"F",  lo:0,   hi:15},  // CHANGED: F grade range is now 0-15 (instead of 0-59)
    {label:"D",  lo:60, hi:63},
    {label:"D+", lo:64, hi:66},
    {label:"C-", lo:67, hi:69},
    {label:"C",  lo:70, hi:72},
    {label:"C+", lo:73, hi:75},
    {label:"B-", lo:76, hi:79},
    {label:"B",  lo:80, hi:84},
    {label:"B+", lo:85, hi:89},
    {label:"A-", lo:90, hi:92},
    {label:"A",  lo:93, hi:96},
    {label:"A+", lo:97, hi:100},
  ];

  const TERMS = [];
  for(let i=1;i<=10;i+=2){
    TERMS.push(`Semester ${i}`);
    TERMS.push(`Semester ${i+1}`);
    TERMS.push(`Summer ${(i+1)/2}`);
  }

  const termsEl = document.getElementById('terms');

  function el(tag, attrs={}, children=[]) {
    const e = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if(k==="#text") e.textContent = v; else e.setAttribute(k, v);
    }
    for (const c of children){ e.appendChild(c); }
    return e;
  }

  function inputNumber(attrs={}){ 
    return el('input', Object.assign({
      type:'number', 
      step:'0.1',
      onwheel: 'this.blur()'
    }, attrs)); 
  }
  
  function inputText(attrs={}){ 
    return el('input', Object.assign({
      type:'text'
    }, attrs)); 
  }
  
  function selectLetter(){
    const s = el('select');
    s.appendChild(el('option',{value:"","#text":"Select"}));
    
    ["A+","A","A-","B+","B","B-","C+","C","C-","D+","D","F","P","W"].forEach(g=> {
      const option = el('option',{value:g,"#text":g});
      s.appendChild(option);
    });
    
    return s;
  }

  function makeTerm(name, index){
    const termCard = el('div',{class:'term-card'});
    const head = el('header',{class:'term-header'},[
      el('div',{class:'term-title'},[el('strong',{"#text":name})]),
      el('div',{class:'term-stats'},[
        statBox('Semester GPA', `semGpa_${index}`),
        statBox('Cumulative GPA', `cumGpa_${index}`),
        statBox('Rounded GPA', `roundedGpa_${index}`)
      ])
    ]);

    const table = el('table');
    const thead = el('thead');
    const thr = el('tr');
    
    // Define column headers - EXACTLY 14 COLUMNS AS BEFORE
    const cols = [
      'Course Code','Subject','7th (30)','12th (20)','Work (10)','Coursework',
      'Final (40)','Total (100)','Final Range','Total Range',
      'Credits','Grade (Letter)','Grade Points','Quality Points'
    ];
    
    cols.forEach(c=> thr.appendChild(el('th',{"#text":c})));
    thead.appendChild(thr); 
    table.appendChild(thead);

    const tbody = el('tbody');
    const rows=[];

    for(let r=0;r<SUBJECT_ROWS;r++){
      const tr = el('tr');
      
      // Create inputs - EXACTLY SAME AS BEFORE
      const courseCode = inputText({placeholder:'CSE101'});
      const subject = inputText({placeholder:'Course'});
      const seventh = inputNumber({max:'30', min:'0'});
      const twelfth = inputNumber({max:'20', min:'0'});
      const work = inputNumber({max:'10', min:'0'});
      const coursework = inputNumber({readonly:true});
      const final = inputNumber({max:'40', min:'0'});
      const total = inputNumber({readonly:true});
      const finalRange = inputText({readonly:true, class:'ranges'});
      const totalRange = inputText({readonly:true, class:'ranges'});
      const credits = inputNumber({min:'0', max:'10', step:'1'});
      const gradeLetter = selectLetter();
      const gradePoints = inputNumber({readonly:true});
      const qualityPoints = inputNumber({readonly:true});

      const inputs = {
        courseCode, subject, seventh, twelfth, work, coursework, 
        final, total, finalRange, totalRange, credits, gradeLetter, 
        gradePoints, qualityPoints
      };

      // Add event listeners - SAME AS BEFORE
      [courseCode, subject, seventh, twelfth, work, final, credits, gradeLetter].forEach(inp => {
        inp.addEventListener('input', () => {
          computeRow(inputs);
          computeTerm(termCard);
          computeAll();
          autoSave();
        });
      });

      // Add cells to row - SAME ORDER AS BEFORE
      [
        courseCode, subject, seventh, twelfth, work, coursework, 
        final, total, finalRange, totalRange, credits, gradeLetter, 
        gradePoints, qualityPoints
      ].forEach(inp => tr.appendChild(el('td',{},[inp])));
      
      tbody.appendChild(tr);
      rows.push(inputs);
    }
    
    table.appendChild(tbody);
    termCard.appendChild(head);
    termCard.appendChild(table);
    termCard.__rows = rows; 
    termCard.__index = index;
    
    return termCard;
  }

  function statBox(label, id){ 
    return el('div',{class:'stat-box'},[
      el('div',{class:'stat-label', "#text":label}),
      el('div',{class:'stat-value', id: id, "#text":'0.000'})
    ]); 
  }
  
  function num(v){const x=parseFloat(v);return isNaN(x)?0:x;}
  
  function formatNumber(value, decimals = 1) {
    if (value === 0 || value === '') return '';
    
    const numValue = parseFloat(value);
    if (isNaN(numValue)) return '';
    
    if (numValue % 1 === 0) {
      return numValue.toString();
    }
    
    return numValue.toFixed(decimals);
  }
  
  function roundGPA(gpa) {
    if (gpa === 0) return 0.00;
    return Math.round(gpa * 10) / 10;
  }

  function computeRow(r){
    const s = num(r.seventh.value); 
    const t = num(r.twelfth.value); 
    const w = num(r.work.value);
    
    const cw = s + t + w; 
    r.coursework.value = formatNumber(cw);
    
    const f = r.final.value === '' ? null : num(r.final.value);
    const totalValue = (f !== null) ? (cw + f) : null;
    r.total.value = totalValue !== null ? formatNumber(totalValue) : '';

    const letter = r.gradeLetter.value;
    
    if(letter === "W"){
      r.finalRange.value = '';
      r.totalRange.value = '';
      r.gradePoints.value = '';
      r.qualityPoints.value = '';
      return;
    }
    
    if(letter === "P"){
      r.finalRange.value = '';
      r.totalRange.value = '';
      r.gradePoints.value = '';
      r.qualityPoints.value = '';
      return;
    }
    
    // Calculate ranges for letter grades - F GRADE HAS 0-15 FINAL RANGE
    if(letter && letter !== "Select"){
      const band = GRADE_RANGES.find(b => b.label === letter);
      if(band){
        const cwNum = num(r.coursework.value);
        const lo = Math.max(0, band.lo - cwNum); 
        const hi = Math.max(0, band.hi - cwNum);
        
        // For F grade, show 0-15 Final Range regardless of coursework
        if (letter === "F") {
          // Final Range is always 0-15 for F grade
          r.finalRange.value = "0-15";
          
          // Total Range is coursework + 0 to coursework + 15
          const totalLo = cwNum;
          const totalHi = cwNum + 15;
          const totalLoFormatted = formatNumber(totalLo);
          const totalHiFormatted = formatNumber(totalHi);
          r.totalRange.value = `${totalLoFormatted}-${totalHiFormatted}`;
        } else {
          // For other grades, show empty if range is 0-0
          if (lo === 0 && hi === 0) {
            r.finalRange.value = '';
          } else {
            const loFormatted = formatNumber(lo);
            const hiFormatted = formatNumber(hi);
            r.finalRange.value = `${loFormatted}-${hiFormatted}`;
          }
          
          const totalLo = cwNum + lo;
          const totalHi = cwNum + hi;
          const totalLoFormatted = formatNumber(totalLo);
          const totalHiFormatted = formatNumber(totalHi);
          r.totalRange.value = `${totalLoFormatted}-${totalHiFormatted}`;
        }
      } else {
        r.finalRange.value = '';
        r.totalRange.value = '';
      }
    } else {
      r.finalRange.value = '';
      r.totalRange.value = '';
    }

    // Calculate grade points and quality points
    const gp = GRADE_POINTS[letter] ?? ''; 
    r.gradePoints.value = gp ? formatNumber(gp, 2) : '';
    const cr = num(r.credits.value); 
    r.qualityPoints.value = (gp && cr) ? formatNumber(cr * gp, 3) : '';
  }

  function computeTerm(termCard){
    let qp = 0, cr = 0;
    for(const r of termCard.__rows){
      const letter = r.gradeLetter.value;
      
      if(letter === "W" || letter === "P" || letter === "Select" || letter === "") continue;
      
      const gp = parseFloat(r.gradePoints.value); 
      const c = parseFloat(r.credits.value);
      
      // For F grades, credits count but quality points are 0
      if(letter === "F" && !isNaN(c)){
        cr += c;
        // qp remains 0 for F grades
        continue;
      }
      
      if(!isNaN(gp) && !isNaN(c)){
        qp += gp * c; 
        cr += c;
      }
    }
    
    const gpa = cr > 0 ? (qp / cr) : 0;
    const roundedGpa = roundGPA(gpa);
    
    const gEl = termCard.querySelector(`#semGpa_${termCard.__index}`);
    if(gEl) gEl.textContent = cr > 0 ? gpa.toFixed(3) : '0.000';
    
    return {qp, cr, gpa, roundedGpa};
  }

  function computeAll(){
    let runningQP = 0, runningCR = 0;
    const termCards = [...document.querySelectorAll('.term-card')];
    
    const allCourses = [];
    termCards.forEach((termCard, termIndex) => {
      termCard.__rows.forEach(row => {
        const courseCode = row.courseCode.value.trim();
        const grade = row.gradeLetter.value;
        const credits = parseFloat(row.credits.value) || 0;
        const qualityPoints = parseFloat(row.qualityPoints.value) || 0;
        
        if (courseCode && grade !== "W" && grade !== "P" && grade !== "Select" && grade !== "") {
          allCourses.push({
            courseCode,
            grade,
            credits,
            qualityPoints,
            termIndex
          });
        }
      });
    });
    
    const courseMap = new Map();
    
    allCourses.forEach(course => {
      if (!courseMap.has(course.courseCode)) {
        courseMap.set(course.courseCode, course);
        runningCR += course.credits;
        runningQP += course.qualityPoints;
      } else {
        const previousCourse = courseMap.get(course.courseCode);
        runningCR -= previousCourse.credits;
        runningQP -= previousCourse.qualityPoints;
        
        runningCR += course.credits;
        runningQP += course.qualityPoints;
        
        courseMap.set(course.courseCode, course);
      }
    });
    
    const overallGpa = runningCR > 0 ? (runningQP / runningCR) : 0;
    const overallRoundedGpa = roundGPA(overallGpa);
    
    document.getElementById('overallQp').textContent = runningQP.toFixed(3);
    document.getElementById('overallCredits').textContent = runningCR.toFixed(0);
    document.getElementById('overallGpa').textContent = runningCR > 0 ? overallGpa.toFixed(3) : '0.000';
    document.getElementById('overallGpaRounded').textContent = runningCR > 0 ? overallRoundedGpa.toFixed(1) : '0.0';
    
    termCards.forEach((termCard, termIndex) => {
      const termResult = computeTerm(termCard);
      
      const coursesUpToTerm = allCourses.filter(course => course.termIndex <= termIndex);
      const courseMapUpToTerm = new Map();
      let termCumulativeQP = 0;
      let termCumulativeCR = 0;
      
      coursesUpToTerm.forEach(course => {
        if (!courseMapUpToTerm.has(course.courseCode)) {
          courseMapUpToTerm.set(course.courseCode, course);
          termCumulativeCR += course.credits;
          termCumulativeQP += course.qualityPoints;
        } else {
          const previousCourse = courseMapUpToTerm.get(course.courseCode);
          termCumulativeCR -= previousCourse.credits;
          termCumulativeQP -= previousCourse.qualityPoints;
          
          termCumulativeCR += course.credits;
          termCumulativeQP += course.qualityPoints;
          
          courseMapUpToTerm.set(course.courseCode, course);
        }
      });
      
      const termCumulativeGpa = termCumulativeCR > 0 ? (termCumulativeQP / termCumulativeCR) : 0;
      const termRoundedGpa = roundGPA(termCumulativeGpa);
      
      const cEl = termCard.querySelector(`#cumGpa_${termCard.__index}`);
      const rEl = termCard.querySelector(`#roundedGpa_${termCard.__index}`);
      
      if (cEl) {
        cEl.textContent = termCumulativeCR > 0 ? termCumulativeGpa.toFixed(3) : '0.000';
      }
      if (rEl) {
        rEl.textContent = termCumulativeCR > 0 ? termRoundedGpa.toFixed(1) : '0.0';
      }
    });
  }

  // Save/Load functions
  function saveData(showMsg = true){
    const data = [];
    const termCards = [...document.querySelectorAll('.term-card')];
    termCards.forEach(term => {
      const rows = [];
      term.__rows.forEach(r => {
        rows.push({
          courseCode: r.courseCode.value,
          subject: r.subject.value,
          seventh: r.seventh.value,
          twelfth: r.twelfth.value,
          work: r.work.value,
          final: r.final.value,
          credits: r.credits.value,
          gradeLetter: r.gradeLetter.value
        });
      });
      data.push(rows);
    });
    localStorage.setItem("gpaData", JSON.stringify(data));

    if(showMsg){
      const notification = document.getElementById("saveNotification");
      notification.textContent = "Saved to browser!";
      notification.classList.add("show");
      setTimeout(() => notification.classList.remove("show"), 2000);
    }
  }

  function loadData(){
    const saved = localStorage.getItem("gpaData");
    if(!saved) return;
    const data = JSON.parse(saved);
    const termCards = [...document.querySelectorAll('.term-card')];
    data.forEach((rows, ti) => {
      if(termCards[ti]){
        rows.forEach((row, ri) => {
          const r = termCards[ti].__rows[ri];
          if(r){
            r.courseCode.value = row.courseCode || "";
            r.subject.value = row.subject || "";
            r.seventh.value = row.seventh || "";
            r.twelfth.value = row.twelfth || "";
            r.work.value = row.work || "";
            r.final.value = row.final || "";
            r.credits.value = row.credits || "";
            r.gradeLetter.value = row.gradeLetter || "";
            computeRow(r);
          }
        });
        computeTerm(termCards[ti]);
      }
    });
    computeAll();
  }

  function resetAll(){
    if(!confirm("Are you sure you want to reset everything?")) return;
    localStorage.removeItem("gpaData");
    location.reload();
  }

  function exportData(){
    saveData(false);
    const data = localStorage.getItem("gpaData");
    if(!data){
      alert("No data to export!");
      return;
    }

    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "aast-gpa-data.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importData(){
    document.getElementById("importFile").click();
  }

  function handleImport(event){
    const file = event.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e){
      try {
        const importedData = JSON.parse(e.target.result);
        if (Array.isArray(importedData) && importedData.length > 0 && 
            Array.isArray(importedData[0]) && importedData[0].length > 0) {
          localStorage.setItem("gpaData", JSON.stringify(importedData));
          alert("Data imported successfully! Reloading...");
          location.reload();
        } else {
          alert("Invalid file format! The file doesn't contain valid GPA data.");
        }
      } catch(err){
        alert("Invalid file format! " + err.message);
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  function autoSave(){
    saveData(false);
  }

  // Build page
  const cards = TERMS.map((name, i) => makeTerm(name, i));
  cards.forEach(c => termsEl.appendChild(c));
  computeAll();

  // Setup event listeners
  document.getElementById("saveBtn").addEventListener("click", () => saveData(true));
  document.getElementById("exportBtn").addEventListener("click", exportData);
  document.getElementById("importBtn").addEventListener("click", importData);
  document.getElementById("resetBtn").addEventListener("click", resetAll);
  document.getElementById("importFile").addEventListener("change", handleImport);

  // Auto-load if data exists
  loadData();

})();
</script>
</body>
</html>
